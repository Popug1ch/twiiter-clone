name: Full CI/CD Diploma
on: [push, pull_request]

jobs:
  lint-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with: { python-version: '3.12' }
    - run: |
        pip install black flake8 pytest pytest-asyncio httpx pytest-cov
        black --check .
        flake8 app/ tests/ --config=.flake8
        pytest tests/ -v --cov=app --cov-report=xml
    - uses: codecov/codecov-action@v4  # coverage отчет

  docker:
    needs: lint-test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: docker/build-push-action@v6
      with:
        context: .
        push: false
        tags: ghcr.io/popug1ch/microblog-backend:${{ github.sha }}
    - run: docker-compose up -d --build && sleep 10 && curl -f http://localhost:8000/health
